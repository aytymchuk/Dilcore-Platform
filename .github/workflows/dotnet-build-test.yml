name: .NET Build & Test Template

on:
  workflow_call:
    inputs:
      build-target:
        required: true
        type: string
        description: "Project or solution to build"
      test-target:
        required: false
        type: string
        description: "Project or solution or pattern to test"
        default: ""
      test-arguments:
        required: false
        type: string
        description: "Additional arguments to pass to dotnet test"
        default: ""
      docker-enabled:
        required: false
        type: boolean
        default: false
      docker-image-name:
        required: false
        type: string
      dockerfile-path:
        required: false
        type: string
      check-name:
        required: false
        type: string
        description: "Name of the check run for test results"
        default: "Test Results"

jobs:
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    env:
      GITHUB_PACKAGES_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_USERNAME: ${{ github.repository_owner }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x
          
      - name: ðŸ” Configure NuGet authentication
        uses: ./.github/actions/configure-nuget-auth
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-username: ${{ github.repository_owner }}


      - name: ðŸ” Validate Docker Inputs
        if: ${{ inputs.docker-enabled }}
        run: |
          if [ -z "${{ inputs.docker-image-name }}" ] || [ -z "${{ inputs.dockerfile-path }}" ]; then
            echo "::error::Both docker-image-name and dockerfile-path inputs are required when docker-enabled is true."
            exit 1
          fi

      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore "${{ inputs.build-target }}"

      - name: ðŸ—ï¸ Build
        run: dotnet build "${{ inputs.build-target }}" --no-restore

      - name: ðŸ³ Build Docker image
        if: ${{ inputs.docker-enabled }}
        run: |
          docker build \
            --build-arg "BUILD_VERSION=${{ github.sha }}" \
            -f "${{ inputs.dockerfile-path }}" \
            -t "${{ inputs.docker-image-name }}:${{ github.sha }}" \
            .

      - name: âœ… Test
        if: ${{ inputs.test-target != '' }}
        run: |
          dotnet test ${{ inputs.test-target }} \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --logger "junit;LogFilePath=${{ github.workspace }}/TestResults/junit-{assembly}.xml" \
            --results-directory "TestResults" \
            ${{ inputs.test-arguments }}

      - name: ðŸ“Š Generate Coverage Report
        uses: danielpalme/ReportGenerator-GitHub-Action@v5
        if: always() && inputs.test-target != ''
        with:
          reports: '**/coverage.cobertura.xml'
          targetdir: 'coveragereport'
          reporttypes: 'HtmlInline;MarkdownSummaryGithub'

      - name: ðŸ“ Add Coverage Summary
        if: always() && inputs.test-target != ''
        run: |
          if [ -f coveragereport/SummaryGithub.md ]; then
            cat coveragereport/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No coverage summary found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload Coverage Report
        uses: actions/upload-artifact@v6
        if: always() && inputs.test-target != ''
        with:
          name: coverage-report-${{ inputs.check-name }}
          path: coveragereport

      - name: ðŸ“‹ Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && inputs.test-target != ''
        with:
          files: 'TestResults/junit-*.xml'
          check_name: ${{ inputs.check-name }}

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v6
        if: always() && inputs.test-target != ''
        with:
          name: test-results-${{ inputs.check-name }}
          path: TestResults
